<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoja de Servicio: Rastreador Kroot (Angryhands)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --kroot-green: #68cc66;
            --kroot-dark: #0a0a0a;
            --terminal-green: #4ade80;
            --alert-red: #f87171;
            --bg-dark: #050505; /* Fondo más oscuro para contraste */
            --panel-bg: #121212;
            --border-color: #444; /* Bordes más claros */
            
            /* Rarities */
            --common: #a3a3a3;
            --uncommon: #1eff00;
            --rare: #0070dd;
            --epic: #a335ee;
            --legendary: #ff8000;
            --junk: #78716c;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background-color: var(--bg-dark);
            color: #e5e7eb; /* Texto base casi blanco (gray-200) */
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%);
        }

        h1, h2, h3, .stat-value, .tech-font, input.tech-font {
            font-family: 'Share Tech Mono', monospace;
        }

        /* UI Panels */
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: linear-gradient(90deg, #262626 0%, #161616 100%);
            border-bottom: 1px solid #444;
            padding: 0.5rem 1rem;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #ffffff; /* ANTES: #9ca3af. AHORA: Blanco puro para encabezados */
            font-weight: bold;
            flex-shrink: 0;
            letter-spacing: 0.05em;
        }

        .panel-content {
            flex-grow: 1;
        }

        /* Kroot Hunger Die */
        .hunger-die {
            font-size: 2.5rem;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            border: 4px solid var(--terminal-green);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 0 10px currentColor;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.2);
        }

        /* Arrows & Inputs */
        .arrow-btn {
            background: transparent;
            border: none;
            color: #e5e7eb; /* ANTES: #9ca3af. AHORA: Gris casi blanco */
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .arrow-btn:hover { color: var(--terminal-green); transform: scale(1.1); }
        .arrow-btn:active { transform: scale(0.9); }
        .arrow-btn-sm { font-size: 0.8rem; padding: 2px; width: 100%; }
        .arrow-btn-lg { font-size: 1.2rem; padding: 0 10px; }

        .editable {
            background: transparent;
            border: none;
            color: #fff; /* Blanco puro para inputs */
            text-align: center;
            width: 100%;
            font-family: 'Share Tech Mono', monospace;
            appearance: none;
            -moz-appearance: textfield;
            font-weight: bold;
        }
        .editable:focus { outline: none; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* GEAR SLOTS */
        .gear-slot {
            width: 50px;
            height: 50px;
            background-color: #1f1f1f;
            border: 2px solid #555;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .gear-slot:hover { border-color: #aaa; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .gear-slot.filled { border-color: var(--terminal-green); background-size: cover; }
        .gear-slot i { font-size: 1.4rem; color: #9ca3af; } /* ANTES: #6b7280. AHORA: Gris más claro para iconos vacíos */
        
        /* Rarity Borders & Text */
        .gear-slot.rare { border-color: var(--rare); box-shadow: inset 0 0 5px var(--rare); }
        .gear-slot.epic { border-color: var(--epic); box-shadow: inset 0 0 5px var(--epic); }
        .gear-slot.uncommon { border-color: var(--uncommon); box-shadow: inset 0 0 5px var(--uncommon); }
        .gear-slot.common { border-color: var(--common); }
        .gear-slot.junk { border-color: var(--junk); }

        .text-rare { color: var(--rare); }
        .text-epic { color: var(--epic); }
        .text-uncommon { color: var(--uncommon); }
        .text-common { color: var(--common); }
        .text-junk { color: var(--junk); }

        /* Tooltip */
        .item-tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            background: #111;
            border: 1px solid #666;
            padding: 10px;
            z-index: 50;
            display: none;
            pointer-events: none;
            border-radius: 6px;
            font-size: 0.75rem;
            box-shadow: 0 10px 30px rgba(0,0,0,1);
            color: #eee;
        }
        .gear-slot:hover .item-tooltip { display: block; }

        /* Character Model */
        .char-model {
            height: 380px;
            background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_S2h2i0H9O_XnK_-z-JvXN2d_2Xy5s6tH_g&usqp=CAU'); 
            background-size: cover;
            background-position: center;
            filter: grayscale(20%) contrast(110%);
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            border-radius: 8px;
            border: 1px solid #333;
        }

        /* Checkbox Custom */
        .kroot-check {
            appearance: none;
            background-color: #333;
            width: 14px;
            height: 14px;
            border: 1px solid #666;
            display: inline-grid;
            place-content: center;
            cursor: pointer;
        }
        .kroot-check::before {
            content: "";
            width: 8px;
            height: 8px;
            transform: scale(0);
            background-color: var(--kroot-green);
            transition: 120ms transform ease-in-out;
        }
        .kroot-check:checked::before { transform: scale(1); }
        .kroot-check:checked { border-color: var(--kroot-green); }

        /* Details & Summary */
        details > summary { list-style: none; cursor: pointer; transition: background 0.2s; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: rgba(255, 255, 255, 0.1); }
        .detail-content { animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Buff Card Styles */
        .buff-card {
            background: rgba(40, 40, 40, 0.6); /* Más claro para leer */
            border: 1px solid #555;
            border-left-width: 3px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .buff-card:hover { background: rgba(60, 60, 60, 0.8); border-color: #777; }
        .buff-green { border-left-color: var(--terminal-green); }
        .buff-purple { border-left-color: #a855f7; }
        .buff-red { border-left-color: #ef4444; }
        .buff-blue { border-left-color: #3b82f6; }

        /* RICH TEXT STYLES (Para las descripciones) */
        .rich-text { color: #f3f4f6; } /* ANTES: #d1d5db. AHORA: Gris 100 (muy claro) */
        .rich-text ul { list-style-type: disc; padding-left: 1.2rem; margin-top: 0.2rem; margin-bottom: 0.2rem; }
        .rich-text ol { list-style-type: decimal; padding-left: 1.2rem; margin-top: 0.2rem; margin-bottom: 0.2rem; }
        .rich-text li { margin-bottom: 2px; }
        .rich-text b, .rich-text strong { color: #fff; font-weight: bold; }
        .rich-text i, .rich-text em { font-style: italic; color: #d1d5db; }
        .rich-text u { text-decoration: underline; }
        .rich-text p { margin-bottom: 4px; }
        
        /* Editor Toolbar */
        .editor-toolbar {
            display: flex;
            background: #2a2a2a;
            border-bottom: 1px solid #555;
            padding: 2px;
        }
        .editor-toolbar button {
            padding: 2px 8px;
            font-size: 11px;
            color: #ccc;
            border-right: 1px solid #444;
        }
        .editor-toolbar button:hover { color: #fff; background: #444; }
        .editor-content {
            padding: 6px;
            min-height: 50px;
            background: #1f1f1f;
            color: #eee;
            font-size: 11px;
            outline: none;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        /* Utilerías de texto */
        .label-text { color: #e5e7eb; font-size: 10px; font-weight: bold; text-transform: uppercase; } /* ANTES: #9ca3af. AHORA: Gris claro */
        .val-text { color: #fff; font-weight: bold; }
        .desc-text { color: #f3f4f6; font-size: 10px; } /* ANTES: #d1d5db. AHORA: Gris claro */
    </style>
</head>
<body class="p-2 md:p-6 pb-20 h-screen overflow-hidden flex flex-col">
    
    <div class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">

        <!-- HEADER SECTION (AHORA EXPANDIBLE CON LORE) -->
        <details class="lg:col-span-12 panel border-t-4 border-t-green-600 shrink-0 group">
            <summary class="p-4 flex flex-col md:flex-row justify-between items-center cursor-pointer hover:bg-white/5 transition select-none">
                <div class="flex items-center gap-4">
                    <div class="h-16 w-16 bg-cover bg-center rounded border border-gray-500 shadow-inner" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_S2h2i0H9O_XnK_-z-JvXN2d_2Xy5s6tH_g&usqp=CAU'); filter: grayscale(20%);"></div>
                    <div>
                        <h1 class="text-3xl font-bold text-white uppercase tracking-wider flex items-center gap-2">
                            Rastreador Kroot 
                            <i class="fas fa-chevron-down text-xs text-gray-200 group-open:rotate-180 transition"></i>
                        </h1>
                        <div class="flex gap-2 text-xs font-mono text-gray-200 mt-1">
                            <span class="bg-[#333] px-2 py-0.5 rounded border border-gray-600">MERCENARIO GOURMET</span>
                            <span class="bg-[#333] px-2 py-0.5 rounded border border-gray-600">JAURÍA DE GURK</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 md:mt-0 text-right space-y-1">
                    <div class="label-text tracking-widest">Estado Operativo</div>
                    <div class="text-xl text-green-400 font-bold font-mono">ANGRYHANDS</div>
                    <div class="text-xs text-gray-200 font-mono">ID: XENO-MERC-040</div>
                </div>
            </summary>

            <!-- LORE CONTENT (Desde Kroot-1.pdf) -->
            <div class="p-4 pt-0 border-t border-gray-700 bg-[#151515] rich-text">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <!-- Perfil -->
                    <div>
                        <h4 class="text-green-400 font-bold uppercase text-xs mb-2 border-b border-green-800 pb-1">Perfil: El Anticuerpo de la Nave</h4>
                        <p class="text-xs text-gray-200 mb-2 italic">"La nave es un buffet. Tú decides quién llega al postre."</p>
                        <ul class="text-[11px] space-y-1 text-gray-200 list-none pl-0">
                            <li><strong class="text-white">Rol:</strong> Tanque Biológico, DPS Melé y Ladrón.</li>
                            <li><strong class="text-white">Misión:</strong> Correo de Lady Viraque. Llevar viales químicos a Skrag.</li>
                            <li><strong class="text-white">Filosofía:</strong> Lo que no te mata, te hace más fuerte. Y lo que no está clavado, es tuyo.</li>
                            <li><strong class="text-white">Vicio:</strong> Cleptomanía (Si ves bolsillos, metes la mano).</li>
                        </ul>
                    </div>
                    <!-- Tabú -->
                    <div>
                        <h4 class="text-red-400 font-bold uppercase text-xs mb-2 border-b border-red-900 pb-1">El Tabú de Gurk (Regla de Oro)</h4>
                        <p class="text-[11px] text-gray-200 mb-2">Prohibido terminantemente consumir los siguientes tejidos:</p>
                        <ul class="text-[11px] text-red-300 space-y-1 list-none pl-0">
                            <li><i class="fas fa-ban mr-1"></i> <strong>Orkos:</strong> Esporas contagiosas.</li>
                            <li><i class="fas fa-ban mr-1"></i> <strong>Tiránidos:</strong> La "Hambre Maldita".</li>
                            <li><i class="fas fa-ban mr-1"></i> <strong>Comida Procesada:</strong> "Ceniza" humana.</li>
                        </ul>
                        <p class="text-[10px] text-gray-400 mt-2 italic">Romper el tabú tiene consecuencias evolutivas graves.</p>
                    </div>
                </div>
            </div>
        </details>

        <!-- SESSION LOG SECTION -->
        <details class="lg:col-span-12 panel shrink-0 group border-t-2 border-t-yellow-600/50">
            <summary class="p-2 flex justify-between items-center cursor-pointer hover:bg-white/5 transition select-none bg-[#161616]">
                <div class="flex items-center gap-2">
                    <i class="fas fa-file-signature text-yellow-500"></i>
                    <span class="text-xs font-bold text-white uppercase tracking-wider">Log de la Sesión</span>
                </div>
                <i class="fas fa-chevron-down text-xs text-gray-200 group-open:rotate-180 transition"></i>
            </summary>
            <div class="p-2 border-t border-[#333] bg-[#121212]">
                <!-- Toolbar -->
                <div class="flex border border-[#444] rounded-t bg-[#2a2a2a] border-b-0">
                     <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-bold"></i></button>
                     <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-italic"></i></button>
                     <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-underline"></i></button>
                     <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-list-ul"></i></button>
                     <div class="flex-grow"></div>
                     <button onclick="document.getElementById('session-log').innerHTML = ''" class="p-1 px-3 text-gray-400 hover:text-red-400 text-[10px]" title="Borrar Log"><i class="fas fa-trash"></i></button>
                </div>
                <!-- Editor -->
                <div id="session-log" class="p-3 text-[11px] text-gray-200 min-h-[100px] max-h-[200px] overflow-y-auto rich-text bg-[#1f1f1f] border border-[#444] rounded-b focus:outline-none" contenteditable="true">
                    <p class="text-gray-500 italic">Registro de misión iniciado. Haz clic para editar...</p>
                </div>
            </div>
        </details>

        <!-- LEFT COLUMN: Stats, Vitals, Hunger & Buffs -->
        <div class="lg:col-span-4 space-y-4 overflow-y-auto pr-2 pb-20">
            
            <!-- Vitals -->
            <div class="panel p-4 shrink-0">
                <h2 class="text-white text-xs font-bold uppercase mb-3 flex items-center gap-2">
                    <i class="fas fa-heartbeat text-red-400"></i> Constantes Vitales
                </h2>
                <div class="flex justify-between items-center mb-4">
                    <!-- Heridas Control -->
                    <div class="text-center flex flex-col items-center">
                        <label class="label-text block mb-1">Heridas</label>
                        <div class="flex items-center bg-[#222] rounded border border-gray-600 p-1">
                            <button onclick="modVal('hp', -1)" class="arrow-btn px-2 text-gray-300 hover:text-red-400"><i class="fas fa-caret-left"></i></button>
                            <input id="hp" type="number" value="12" class="editable text-3xl font-bold text-white h-10 w-16">
                            <button onclick="modVal('hp', 1)" class="arrow-btn px-2 text-gray-300 hover:text-green-400"><i class="fas fa-caret-right"></i></button>
                        </div>
                    </div>
                    <!-- Armadura -->
                    <div class="text-center border-x border-gray-700 px-4">
                        <label class="label-text block text-blue-300">Armadura</label>
                        <div class="text-4xl font-bold text-blue-400 font-mono">7</div>
                        <div class="text-[10px] text-gray-300">3 Piel + 4 Res</div>
                    </div>
                    <!-- Destino Control -->
                    <div class="text-center flex flex-col items-center">
                        <label class="label-text block mb-1">Destino</label>
                        <div class="flex items-center bg-[#222] rounded border border-gray-600 p-1">
                            <button onclick="modVal('fate', -1)" class="arrow-btn px-2 text-gray-300 hover:text-red-400"><i class="fas fa-caret-left"></i></button>
                            <input id="fate" type="number" value="2" class="editable text-3xl font-bold text-yellow-400 h-10 w-12">
                            <button onclick="modVal('fate', 1)" class="arrow-btn px-2 text-gray-300 hover:text-green-400"><i class="fas fa-caret-right"></i></button>
                        </div>
                    </div>
                </div>
                <!-- Movement -->
                <div class="bg-[#1a1a1a] p-2 rounded border border-gray-600 text-xs font-mono flex justify-between text-gray-200">
                    <span>MOV:</span>
                    <span class="text-white">6m / 12m / 18m / 28m</span>
                </div>
            </div>

            <!-- Attributes -->
            <div class="panel shrink-0">
                <div class="panel-header text-xs font-bold text-white uppercase">Perfil Genético</div>
                <div class="grid grid-cols-3 gap-px bg-[#444] border-b border-[#444]">
                    <!-- HA -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Habilidad de Armas">
                        <div class="text-[10px] text-green-400 font-bold mb-1">HA</div>
                        <button onclick="modVal('ha', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="ha" type="number" value="50" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('ha', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- HP -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Habilidad de Proyectiles">
                        <div class="text-[10px] text-gray-100 font-bold mb-1">HP</div>
                        <button onclick="modVal('hp_stat', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="hp_stat" type="number" value="35" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('hp_stat', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- F -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Fuerza">
                        <div class="text-[10px] text-gray-100 font-bold mb-1">F</div>
                        <button onclick="modVal('s', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="s" type="number" value="40" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('s', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- R -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Resistencia">
                        <div class="text-[10px] text-gray-100 font-bold mb-1">R</div>
                        <button onclick="modVal('t', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="t" type="number" value="40" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('t', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- AG -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Agilidad">
                        <div class="text-[10px] text-green-400 font-bold mb-1">AG</div>
                        <button onclick="modVal('ag', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="ag" type="number" value="45" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('ag', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- INT -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Inteligencia">
                        <div class="text-[10px] text-gray-100 font-bold mb-1">INT</div>
                        <button onclick="modVal('int', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="int" type="number" value="25" class="editable text-xl font-bold text-gray-200 py-1">
                        <button onclick="modVal('int', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- PER -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Percepción">
                        <div class="text-[10px] text-green-400 font-bold mb-1">PER</div>
                        <button onclick="modVal('per', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="per" type="number" value="50" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('per', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- VOL -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Voluntad">
                        <div class="text-[10px] text-gray-100 font-bold mb-1">VOL</div>
                        <button onclick="modVal('wp', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="wp" type="number" value="30" class="editable text-xl font-bold text-white py-1">
                        <button onclick="modVal('wp', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                    <!-- EMP -->
                    <div class="bg-[#1f1f1f] p-2 flex flex-col items-center hover:bg-[#2a2a2a]" title="Empatía">
                        <div class="text-[10px] text-red-400 font-bold mb-1">EMP</div>
                        <button onclick="modVal('fel', 1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-up"></i></button>
                        <input id="fel" type="number" value="20" class="editable text-xl font-bold text-gray-200 py-1">
                        <button onclick="modVal('fel', -1)" class="arrow-btn arrow-btn-sm hover:bg-[#333] rounded"><i class="fas fa-caret-down"></i></button>
                    </div>
                </div>
            </div>

            <!-- Maldición: Hambre -->
            <div class="panel p-4 border-l-4 border-l-red-600 bg-gradient-to-br from-[#1a1a1a] to-[#250f0f] shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-red-500 font-bold uppercase text-lg">Maldición: Hambre</h3>
                        <div class="text-[10px] text-gray-200">Metabolismo Acelerado</div>
                    </div>
                    <div class="hunger-die text-green-400 shadow-[0_0_15px_rgba(74,222,128,0.3)]">
                        <span id="hungerValue" class="font-mono font-bold">10</span>
                    </div>
                </div>

                <div class="space-y-1 mb-4">
                    <div id="status-10" class="text-xs bg-[#222] p-1 px-2 rounded border-l-2 border-green-500 text-white font-bold opacity-100">10-7: Saciado (Óptimo)</div>
                    <div id="status-6" class="text-xs bg-[#222] p-1 px-2 rounded border-l-2 border-yellow-500 text-gray-200 opacity-50">6-4: Hambriento (-20 Sigilo)</div>
                    <div id="status-3" class="text-xs bg-[#222] p-1 px-2 rounded border-l-2 border-red-500 text-gray-200 opacity-50">3-1: Voraz (-10 Atq, No Correr)</div>
                    <div id="status-0" class="text-xs bg-red-900/30 p-1 px-2 rounded border-l-2 border-red-700 text-red-400 opacity-50 font-bold">0: COLAPSO (Locura)</div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="updateHunger(-1)" class="bg-[#222] hover:bg-red-900/50 text-red-400 text-xs font-bold py-2 rounded border border-gray-600 transition-colors">
                        -1 DESGASTE
                    </button>
                    <button onclick="updateHunger(1)" class="bg-[#222] hover:bg-green-900/50 text-green-400 text-xs font-bold py-2 rounded border border-gray-600 transition-colors">
                        +1 COMER SNACK
                    </button>
                </div>
                
                <details class="mt-3 group buff-card buff-red">
                    <summary class="p-2 text-[10px] text-red-400 cursor-pointer uppercase font-bold flex items-center gap-1 select-none">
                        <i class="fas fa-dna"></i> Rito de Asimilación (Reglas)
                    </summary>
                    <div class="px-2 pb-2 text-[10px] text-gray-200 rich-text">
                        <p class="mb-1"><strong>Acción Completa:</strong> Comer cadáver fresco. +5 Hambre.</p>
                        <p class="font-bold text-white mb-1">Tirada d10:</p>
                        <ul>
                            <li><strong class="text-red-400">1:</strong> Vómito (Fatiga).</li>
                            <li><strong class="text-yellow-400">2-3:</strong> Indigestión (-10 sgte acción).</li>
                            <li><strong class="text-green-400">4-6:</strong> Nutrición (Cura 1d5 Heridas).</li>
                            <li><strong class="text-blue-400">7-8:</strong> Buff Temporal (x1 Combate).</li>
                            <li><strong class="text-purple-400">9-10:</strong> ASIMILACIÓN PERMANENTE.</li>
                        </ul>
                    </div>
                </details>
            </div>

            <!-- Evolución / Buffs (REWORKED + ADD FORM) -->
            <div class="panel p-4 shrink-0">
                <h3 class="font-bold uppercase text-xs mb-4 flex items-center gap-2 text-purple-400">
                    <i class="fas fa-dna"></i> Historial de Evolución
                </h3>

                <!-- ADD BUFF FORM -->
                <div class="p-2 border border-[#444] bg-[#1a1a1a] mb-4 rounded">
                    <div class="flex gap-1 mb-1">
                        <input type="text" id="newBuffName" placeholder="Nombre Habilidad" class="bg-[#2a2a2a] border border-[#555] text-[10px] text-white px-1 w-1/2 focus:outline-none focus:border-purple-500">
                        <select id="newBuffType" class="bg-[#2a2a2a] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none cursor-pointer">
                            <option value="temp">Temporal</option>
                            <option value="perm">Permanente</option>
                        </select>
                    </div>
                    
                    <!-- RICH TEXT EDITOR -->
                    <div class="border border-[#555] rounded bg-[#222] mb-1">
                        <div class="flex border-b border-[#555] bg-[#333]">
                            <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-italic"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-underline"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6"><i class="fas fa-list-ul"></i></button>
                        </div>
                        <div id="newBuffDesc" class="p-2 text-[10px] text-gray-200 min-h-[40px] focus:outline-none max-h-[100px] overflow-y-auto rich-text" contenteditable="true"></div>
                    </div>

                    <div class="flex gap-1">
                         <select id="newBuffColor" class="bg-[#2a2a2a] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none cursor-pointer">
                            <option value="buff-green">Verde (Salud)</option>
                            <option value="buff-purple">Púrpura (Mutación)</option>
                            <option value="buff-red">Rojo (Combate)</option>
                            <option value="buff-blue">Azul (Mental)</option>
                        </select>
                         <select id="newBuffIcon" class="bg-[#2a2a2a] border border-[#555] text-[10px] text-gray-200 px-1 w-1/4 focus:outline-none cursor-pointer">
                            <option value="fa-dna">ADN</option>
                            <option value="fa-heart-pulse">Salud</option>
                            <option value="fa-bolt">Rayo</option>
                            <option value="fa-skull">Calavera</option>
                            <option value="fa-eye">Ojo</option>
                            <option value="fa-person-running">Correr</option>
                        </select>
                        <button onclick="addNewBuff()" class="bg-[#333] hover:bg-purple-700 text-white px-2 text-[10px] border border-[#555] w-1/4 transition"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <!-- Temp Section -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] uppercase text-gray-200 font-bold">Buffs Temporales (1 Combate)</span>
                    </div>
                    <div id="temp-buffs-list" class="space-y-2">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Perm Section -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] uppercase text-gray-200 font-bold">Asimilaciones Permanentes</span>
                    </div>
                    
                    <!-- RICH TEXT EDITOR -->
                    <div class="border border-[#555] rounded bg-[#222] mb-1">
                        <div class="flex border-b border-[#555] bg-[#333]">
                            <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-italic"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-underline"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 text-gray-300 hover:text-white text-[10px] w-6"><i class="fas fa-list-ul"></i></button>
                        </div>
                        <div id="newBuffDesc" class="p-2 text-[10px] text-gray-200 min-h-[40px] focus:outline-none max-h-[100px] overflow-y-auto rich-text" contenteditable="true"></div>
                    </div>

                    <div class="flex gap-1">
                         <select id="newBuffColor" class="bg-[#2a2a2a] border border-[#555] text-[10px] text-gray-300 px-1 w-1/2 focus:outline-none cursor-pointer">
                            <option value="buff-green">Verde (Salud)</option>
                            <option value="buff-purple">Púrpura (Mutación)</option>
                            <option value="buff-red">Rojo (Combate)</option>
                            <option value="buff-blue">Azul (Mental)</option>
                        </select>
                         <select id="newBuffIcon" class="bg-[#2a2a2a] border border-[#555] text-[10px] text-gray-300 px-1 w-1/4 focus:outline-none cursor-pointer">
                            <option value="fa-dna">ADN</option>
                            <option value="fa-heart-pulse">Salud</option>
                            <option value="fa-bolt">Rayo</option>
                            <option value="fa-skull">Calavera</option>
                            <option value="fa-eye">Ojo</option>
                            <option value="fa-person-running">Correr</option>
                        </select>
                        <button onclick="addNewBuff()" class="bg-[#333] hover:bg-purple-700 text-white px-2 text-[10px] border border-[#555] w-1/4 transition"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <!-- Temp Section -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] uppercase text-gray-400 font-bold">Buffs Temporales (1 Combate)</span>
                    </div>
                    <div id="temp-buffs-list" class="space-y-2">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Perm Section -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] uppercase text-gray-400 font-bold">Asimilaciones Permanentes</span>
                    </div>
                    <div id="perm-buffs-list" class="space-y-2">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

        </div>

        <!-- CENTER COLUMN: COMBAT CENTER (Flexible Height) -->
        <div class="lg:col-span-5 flex flex-col gap-4 overflow-y-auto pb-20">
            
            <!-- COMBAT CENTER PANEL -->
            <div class="panel shrink-0 relative bg-[#0e0e0e]">
                <div class="panel-header flex justify-between">
                    <span>Centro de Combate</span>
                    <i class="fas fa-crosshairs"></i>
                </div>
                
                <div class="p-4 relative">
                    <!-- Background Grid -->
                    <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 20px 20px;"></div>

                    <div class="relative flex justify-center">
                        
                        <!-- Left Slots -->
                        <div class="absolute left-0 top-4 flex flex-col gap-3">
                            <!-- Head (Clickable) -->
                            <div id="slot-head" class="gear-slot border-dashed border-gray-600" onclick="unequip('head')">
                                <i class="fas fa-helmet-safety text-gray-600"></i>
                            </div>
                            <!-- Chest -->
                            <div id="slot-body" class="gear-slot border-dashed border-gray-600" onclick="unequip('body')">
                                <i class="fas fa-vest text-gray-600"></i>
                            </div>
                            <!-- Wrists (Clickable) -->
                             <div id="slot-wrists" class="gear-slot border-dashed border-gray-600" onclick="unequip('wrists')">
                                <i class="fas fa-ring text-gray-600"></i>
                            </div>
                            <!-- Trinket 1 -->
                            <div id="slot-trinket1" class="gear-slot border-dashed border-gray-600" onclick="unequip('trinket1')">
                                <i class="fas fa-gem text-gray-600"></i>
                            </div>
                        </div>

                        <!-- CHARACTER MODEL -->
                        <div class="char-model w-full max-w-[280px] mx-12 shadow-[0_0_30px_rgba(0,0,0,0.8)_inset]"></div>

                        <!-- Right Slots -->
                        <div class="absolute right-0 top-4 flex flex-col gap-3">
                            <!-- Hands (Clickable) -->
                            <div id="slot-hands" class="gear-slot border-dashed border-gray-600" onclick="unequip('hands')">
                                <i class="fas fa-mitten text-gray-600"></i>
                            </div>
                            <!-- Legs (Clickable) -->
                             <div id="slot-legs" class="gear-slot border-dashed border-gray-600" onclick="unequip('legs')">
                                <i class="fas fa-socks text-gray-600"></i>
                            </div>
                            <!-- Boots -->
                            <div id="slot-feet" class="gear-slot border-dashed border-gray-600" onclick="unequip('feet')">
                                <i class="fas fa-boot text-gray-600"></i>
                            </div>
                            <!-- Trinket 2 -->
                            <div id="slot-trinket2" class="gear-slot border-dashed border-gray-600" onclick="unequip('trinket2')">
                                <i class="fas fa-gem text-gray-600"></i>
                            </div>
                        </div>

                        <!-- BOTTOM WEAPON SLOTS -->
                        <div class="absolute -bottom-2 flex gap-12 w-full justify-center px-4">
                            <!-- Main Hand -->
                            <div class="flex flex-col items-center">
                                <span class="text-[9px] text-gray-400 uppercase mb-1">Mano Principal</span>
                                <div id="slot-main" class="gear-slot border-dashed border-gray-600" onclick="unequip('main')">
                                    <i class="fas fa-fist-raised text-gray-500"></i>
                                </div>
                            </div>
                            <!-- Off Hand -->
                            <div class="flex flex-col items-center">
                                <span class="text-[9px] text-gray-400 uppercase mb-1">Secundaria</span>
                                <div id="slot-off" class="gear-slot border-dashed border-gray-600" onclick="unequip('off')">
                                    <i class="fas fa-hand-paper text-gray-500"></i>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ACTIVE BUFFS / PROTOCOLS DISPLAY -->
                <div class="mt-8 p-3 bg-[#0a0a0a] border-t border-[#333]">
                    <!-- ACTIVE GEAR DETAILS BOX -->
                    <div class="panel-header mt-2 border-t border-[#444] bg-transparent pl-0 text-blue-400">Detalles de Equipo Activo</div>
                    <div id="active-gear-info" class="space-y-1 mt-1">
                        <!-- Filled by JS -->
                    </div>

                    <div id="protocol-display" class="hidden bg-orange-900/20 border border-orange-700/50 p-2 rounded flex items-center justify-between mb-2 mt-4 animate-pulse">
                        <span class="text-orange-500 text-xs font-bold uppercase"><i class="fas fa-bolt mr-1"></i> Protocolo: Gran Trinchante</span>
                        <span class="text-[9px] text-gray-200">Daga + Tenedor activos</span>
                    </div>
                    <div id="2h-warning" class="hidden text-center text-[10px] text-red-500 font-mono p-1 border border-red-900 bg-red-900/10 rounded">
                        [ARMA A DOS MANOS EQUIPADA - SLOT SECUNDARIO BLOQUEADO]
                    </div>
                </div>
            </div>

            <!-- BATTLE STATUS SECTION -->
            <details class="panel shrink-0 group border-t-2 border-t-red-600/50">
                <summary class="p-2 flex justify-between items-center cursor-pointer hover:bg-white/5 transition select-none bg-[#161616]">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-clipboard-list text-red-500"></i>
                        <span class="text-xs font-bold text-white uppercase tracking-wider">Estado de Batalla</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-200 group-open:rotate-180 transition"></i>
                </summary>
                <div class="p-2 border-t border-[#333] bg-[#121212]">
                    <!-- Toolbar -->
                    <div class="flex border border-[#444] rounded-t bg-[#2a2a2a] border-b-0">
                         <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-bold"></i></button>
                         <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-italic"></i></button>
                         <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-underline"></i></button>
                         <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 px-3 text-gray-200 hover:text-white text-[10px] border-r border-[#444]"><i class="fas fa-list-ul"></i></button>
                         <div class="flex-grow"></div>
                         <button onclick="document.getElementById('battle-status-log').innerHTML = ''" class="p-1 px-3 text-gray-400 hover:text-red-400 text-[10px]" title="Borrar Log"><i class="fas fa-trash"></i></button>
                    </div>
                    <!-- Editor -->
                    <div id="battle-status-log" class="p-3 text-[11px] text-gray-200 min-h-[80px] max-h-[150px] overflow-y-auto rich-text bg-[#1f1f1f] border border-[#444] rounded-b focus:outline-none" contenteditable="true">
                        <p class="text-gray-500 italic">Notas tácticas, condiciones o recordatorios...</p>
                    </div>
                </div>
            </details>

            <!-- DICE ROLLER INTEGRADO -->
            <div class="panel p-3 bg-[#111] shrink-0">
                <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-2">
                    <span class="text-[10px] font-bold text-gray-200 uppercase">Daditos Kroot</span>
                    <span id="rollResult" class="text-2xl font-mono text-white font-bold">--</span>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="roll(100)" class="bg-[#222] hover:bg-[#333] text-gray-200 text-xs py-2 rounded border border-gray-600 font-bold transition">d100</button>
                    <button onclick="roll(20)" class="bg-[#222] hover:bg-[#333] text-gray-200 text-xs py-2 rounded border border-gray-600 transition">d20</button>
                    <button onclick="roll(10)" class="bg-[#222] hover:bg-[#333] text-gray-200 text-xs py-2 rounded border border-gray-600 transition">d10</button>
                    <button onclick="roll(5)" class="bg-[#222] hover:bg-[#333] text-gray-200 text-xs py-2 rounded border border-gray-600 transition">d5</button>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN: ARMERÍA & FARMACIA (Unified Scroll) -->
        <div class="lg:col-span-3 flex flex-col gap-4 overflow-y-auto pr-2 pb-20">

            <!-- Weapons Inventory -->
            <div class="panel shrink-0">
                <div class="panel-header flex justify-between">
                    <span>Armería Disponible</span>
                    <span class="text-xs text-gray-200" id="w-count"></span>
                </div>
                
                <!-- ADD WEAPON -->
                <div class="p-2 border-b border-[#333] bg-[#151515]">
                    <div class="flex gap-1 mb-1">
                        <input type="text" id="newWeaponName" placeholder="Nombre Arma" class="bg-[#222] border border-[#555] text-[10px] text-white px-1 w-1/2 focus:outline-none focus:border-green-500">
                        <input type="text" id="newWeaponStats" placeholder="Daño (ej: 1d10+3)" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none">
                    </div>
                    <!-- RICH TEXT EDITOR -->
                    <div class="border border-[#555] rounded bg-[#1a1a1a] mb-1">
                        <div class="flex border-b border-[#555] bg-[#222]">
                            <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-italic"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-underline"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6"><i class="fas fa-list-ul"></i></button>
                        </div>
                        <div id="newWeaponDesc" class="p-2 text-[10px] text-gray-200 min-h-[40px] focus:outline-none max-h-[100px] overflow-y-auto rich-text" contenteditable="true"></div>
                    </div>
                    <div class="flex gap-1">
                        <select id="newWeaponType" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none cursor-pointer">
                            <option value="1h">1 Mano</option>
                            <option value="2h">2 Manos</option>
                            <option value="shield">Escudo</option>
                        </select>
                        <select id="newWeaponColor" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/4 focus:outline-none cursor-pointer">
                            <option value="text-gray-300">Común</option>
                            <option value="text-blue-400">Raro</option>
                            <option value="text-purple-400">Épico</option>
                        </select>
                        <button onclick="addWeapon()" class="bg-[#333] hover:bg-green-700 text-white px-2 text-[10px] border border-[#555] w-1/4 transition"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div id="inventory-list" class="divide-y divide-[#222] text-xs">
                    <!-- Items generated by JS -->
                </div>
            </div>

            <!-- Armor Inventory -->
             <div class="panel shrink-0">
                <div class="panel-header">Armaduras & Protecciones</div>
                
                <!-- ADD ARMOR -->
                <div class="p-2 border-b border-[#333] bg-[#151515]">
                    <div class="flex gap-1 mb-1">
                        <input type="text" id="newArmorName" placeholder="Nombre Armadura" class="bg-[#222] border border-[#555] text-[10px] text-white px-1 w-1/2 focus:outline-none focus:border-green-500">
                        <input type="text" id="newArmorStats" placeholder="AP (ej: AP 4)" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none">
                    </div>
                    <!-- RICH TEXT EDITOR -->
                    <div class="border border-[#555] rounded bg-[#1a1a1a] mb-1">
                        <div class="flex border-b border-[#555] bg-[#222]">
                            <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-italic"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-underline"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6"><i class="fas fa-list-ul"></i></button>
                        </div>
                        <div id="newArmorDesc" class="p-2 text-[10px] text-gray-200 min-h-[40px] focus:outline-none max-h-[100px] overflow-y-auto rich-text" contenteditable="true"></div>
                    </div>
                    <div class="flex gap-1">
                        <select id="newArmorSlot" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none cursor-pointer">
                            <option value="head">Cabeza</option>
                            <option value="body">Torso</option>
                            <option value="hands">Guantes</option>
                            <option value="wrists">Muñecas</option>
                            <option value="legs">Piernas</option>
                            <option value="feet">Pies</option>
                            <option value="trinket">Abalorio</option>
                        </select>
                        <select id="newArmorColor" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/4 focus:outline-none cursor-pointer">
                            <option value="text-gray-300">Común</option>
                            <option value="text-blue-400">Raro</option>
                            <option value="text-purple-400">Épico</option>
                        </select>
                        <button onclick="addArmor()" class="bg-[#333] hover:bg-green-700 text-white px-2 text-[10px] border border-[#555] w-1/4 transition"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div id="armor-list" class="divide-y divide-[#222] text-xs">
                    <!-- Items generated by JS -->
                </div>
            </div>

            <!-- Bolsa de Snacks (Objetos que se reinician) -->
            <div class="panel shrink-0">
                <div class="panel-header text-xs font-bold text-gray-200 uppercase flex justify-between">
                    <span>Bolsa de Snacks (Suministros)</span>
                    <i class="fas fa-utensils"></i>
                </div>
                <div id="snacks-list" class="divide-y divide-[#333]">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Botín de Batalla (Gestión de Loot) -->
            <div class="panel shrink-0 flex flex-col">
                <div class="panel-header text-xs font-bold text-gray-200 uppercase flex justify-between">
                    <span>Botín de Batalla (Loot)</span>
                    <i class="fas fa-sack-dollar"></i>
                </div>
                
                <!-- ADD NEW ITEM SECTION -->
                <div class="p-2 border-b border-[#333] bg-[#151515]">
                    <div class="flex gap-1 mb-1">
                        <input type="text" id="newItemName" placeholder="Nombre" class="bg-[#222] border border-[#555] text-[10px] text-white px-1 w-1/2 focus:outline-none focus:border-green-500">
                        <select id="newItemColor" class="bg-[#222] border border-[#555] text-[10px] text-gray-200 px-1 w-1/2 focus:outline-none cursor-pointer">
                            <option value="text-gray-400">Gris (Común)</option>
                            <option value="text-green-400">Verde (Uncommon)</option>
                            <option value="text-blue-400">Azul (Raro)</option>
                            <option value="text-purple-400">Púrpura (Épico)</option>
                            <option value="text-orange-400">Naranja (Herejía)</option>
                            <option value="text-red-500">Rojo (Peligro)</option>
                            <option value="text-yellow-500">Amarillo (Warning)</option>
                        </select>
                    </div>
                    <!-- RICH TEXT EDITOR -->
                    <div class="border border-[#555] rounded bg-[#1a1a1a] mb-1">
                        <div class="flex border-b border-[#555] bg-[#222]">
                            <button onmousedown="event.preventDefault(); execCmd('bold')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('italic')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-italic"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('underline')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6 border-r border-[#555]"><i class="fas fa-underline"></i></button>
                            <button onmousedown="event.preventDefault(); execCmd('insertUnorderedList')" class="p-1 text-gray-400 hover:text-white text-[10px] w-6"><i class="fas fa-list-ul"></i></button>
                        </div>
                        <div id="newItemDesc" class="p-2 text-[10px] text-gray-200 min-h-[40px] focus:outline-none max-h-[100px] overflow-y-auto rich-text" contenteditable="true"></div>
                    </div>
                    <div class="flex gap-1 justify-end">
                        <button onclick="addConsumable()" class="bg-[#333] hover:bg-green-700 text-white px-2 text-[10px] border border-[#555] transition w-full"><i class="fas fa-plus"></i> AÑADIR</button>
                    </div>
                </div>

                <div id="consumables-list" class="divide-y divide-[#333]">
                    <!-- Generated by JS -->
                </div>
            </div>

        </div>

    </div>

    <script>
        // --- RICH TEXT HELPER ---
        function execCmd(command) {
            document.execCommand(command, false, null);
        }

        // --- DATA DE OBJETOS ---
        // ... (Keep existing weapon/armor DB)
        let weaponsDB = [
            { id: 'w_sierra', name: 'Daga Sierra "Destripadora"', type: '1h', rarity: 'rare', icon: 'fa-fan', stats: '1d10+1+BF (R) | Pen 2', desc: '<p class="mb-2 italic text-gray-200">"Modelo Gurk-Custom". Híbrido brutal con freno industrial.</p><ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-white">Desgarradora:</strong> Tira 2d10 al daño y quédate el alto.</li><li><strong class="text-white">Equilibrada:</strong> +10 a Parada.</li><li><strong class="text-red-400">Ruidosa:</strong> -20 Sigilo al encenderla.</li></ul>', color: 'text-blue-400' },
            { id: 'w_tenedor', name: 'Cuchillo "El Tenedor"', type: '1h', rarity: 'uncommon', icon: 'fa-utensils', stats: '1d5+4 (R) | Pen 2', desc: '<p class="mb-2 italic text-gray-200">Herramienta de despiece monofilo.</p><ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-green-400">Canalizador:</strong> Si hieres, "Cata de Combate" es GRATIS.</li><li><strong class="text-gray-300">Arrojadiza:</strong> Alcance 5m.</li><li><strong class="text-gray-300">Utilidad:</strong> +10 Supervivencia al despiezar.</li></ul>', color: 'text-green-400' },
            { id: 'w_rifle', name: 'Rifle Kroot (Dual)', type: '2h', rarity: 'common', icon: 'fa-crosshairs', stats: 'Disparo: 1d10+5 (E) | Melé: 1d10+4', desc: '<p class="mb-2 italic text-gray-200">Arma a Dos Manos. Adaptable.</p><ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-blue-400">Modo Disparo:</strong> 100m, Energía, Fiable.</li><li><strong class="text-red-400">Modo Melé:</strong> Cuchillas en cañón/culata.</li></ul>', color: 'text-gray-300' },
            { id: 'w_mandibula', name: 'Mandíbula Trituradora', type: 'shield', rarity: 'epic', icon: 'fa-shield-alt', stats: '1d10+F (I) | +4 AP Escudo', desc: '<p class="mb-2 italic text-gray-200">Hueso de la Madre. Trofeo masivo.</p><ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-purple-400">Escudo Torre:</strong> +4 AP (Brazo/Cuerpo Izq).</li><li><strong class="text-red-400">Terror Primitivo:</strong> +10 Intimidar al rugir.</li><li><strong class="text-gray-300">Pesada:</strong> Requiere F45+.</li></ul>', color: 'text-purple-400' },
            { id: 'w_unarmed', name: 'Puños / Garras', type: '1h', rarity: 'common', icon: 'fa-hand-rock', stats: '1d5+1 (I)', desc: '<ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-gray-300">Primitiva:</strong> La armadura enemiga cuenta doble.</li><li><strong class="text-gray-300">Presa:</strong> Permite iniciar Maniobras de Presa.</li></ul>', color: 'text-gray-500' }
        ];

        let armorDB = [
            { id: 'a_chaleco', name: 'Chaleco "Suela de Tanko"', slot: 'body', rarity: 'common', icon: 'fa-vest', stats: 'AP 4 (Torso)', desc: '<p class="mb-2 italic text-gray-200">Goma vulcanizada. Huele a neumático quemado.</p><ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-green-400">Rebote:</strong> AP 6 vs Impacto/Caídas.</li><li><strong class="text-red-400">Inflamable:</strong> AP 0 vs Fuego. Se derrite (daño extra).</li><li><strong class="text-gray-300">Torpe:</strong> -10 Agilidad.</li></ul>', color: 'text-gray-300' },
            { id: 'a_botas', name: 'Botaz de Rebote', slot: 'feet', rarity: 'rare', icon: 'fa-shoe-prints', stats: 'Salto x3', desc: '<p class="mb-2 italic text-gray-200">Muelles de suspensión oxidados.</p><ul class="list-disc pl-4 space-y-1 lore-list"><li><strong class="text-blue-400">¡Boing!:</strong> Salto x3 (Acción Movimiento).</li><li><strong class="text-red-400">Aterrizaje:</strong> Test AG (+0) o caes (Daño).</li><li><strong class="text-red-400">Ruidosas:</strong> -10 Sigilo/Velocidad.</li></ul>', color: 'text-blue-400' }
        ];

        const snacksDB = [
            { name: "Cecina de Snotling", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-green-400">Curación:</strong> Recupera 1d5 Heridas.</li><li><strong class="text-yellow-400">Saciante:</strong> +3 Hambre.</li></ul>', color: "text-green-400", type: "food", hungerRestore: 3, uses: 3 },
            { name: "Barrita Orka", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-red-400">Energía:</strong> +10 Fuerza (3 Turnos).</li><li><strong class="text-yellow-400">Saciante:</strong> +3 Hambre.</li></ul>', color: "text-green-400", type: "food", hungerRestore: 3, uses: 3 },
            { name: "Gelatina Ocular", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-blue-400">Ocular:</strong> Visión Nocturna y +10 PER (Escena).</li><li><strong class="text-yellow-400">Saciante:</strong> +3 Hambre.</li></ul>', color: "text-green-400", type: "food", hungerRestore: 3, uses: 3 },
            { name: "Polvo de Hueso Kin", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-gray-300">Calcio:</strong> +2 Armadura (Escena).</li><li><strong class="text-yellow-400">Saciante:</strong> +3 Hambre.</li></ul>', color: "text-gray-300", type: "food", hungerRestore: 3, uses: 3 },
            { name: "Furia Rosa (Vial)", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-purple-400">Efecto:</strong> +20 HA/Fuerza (1d10 turnos).</li><li><strong class="text-red-400">Coste:</strong> Frenesí obligatorio. 1d5 Daño al final.</li></ul>', color: "text-purple-400", type: "drug", uses: 1 },
            { name: "Piel de Espejo (Vial)", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-blue-300">Efecto:</strong> Enemigos -30 a Impactarte.</li><li><strong class="text-red-400">Coste:</strong> Sufres 1 Herida/turno (Piel arde).</li></ul>', color: "text-blue-300", type: "drug", uses: 1 }
        ];

        let lootDB = [
            { name: "Spook (Fantasma)", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-green-400">Viaje:</strong> +20 PER / Psíquico Nvl 1.</li><li><strong class="text-red-400">Peligro:</strong> Detectado por S-99. +1d5 Corrupción.</li></ul>', color: "text-green-400", type: "drug" },
            { name: "Éxtasis de Navaja", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-purple-400">Subidón:</strong> +20 AG/HA, Iniciativa Doble (1d10 rondas).</li><li><strong class="text-gray-300">Bajón:</strong> Depresión (-10).</li></ul>', color: "text-purple-400", type: "drug" },
            { name: "Obscura", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-gray-300">Trance:</strong> Inmune Miedo/Fatiga/Pinning.</li><li><strong class="text-red-400">Resaca:</strong> -10 Vol/Int, -20 Emp.</li></ul>', color: "text-gray-300", type: "drug" },
            { name: "Inyector Zoat", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-orange-400">Xenos:</strong> Cura 1d10+R. Quita Toxinas/Fatiga.</li><li><strong class="text-red-400">Rechazo:</strong> Test R o Aturdido+Daño. +Corr.</li></ul>', color: "text-orange-400", type: "drug" },
            { name: "Neuro-estabilizador", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-blue-300">Mente Fría:</strong> Quita Miedo/Pinning. +20 Vol/Int.</li><li><strong class="text-gray-300">Apatía:</strong> -30 Empatía.</li></ul>', color: "text-blue-300", type: "drug" },
            { name: "Medkit Lázaro", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-green-400">Cirugía:</strong> +20 Medicae.</li><li><strong class="text-red-400">Stimm:</strong> Quita Fatiga/Stun.</li><li><strong class="text-blue-400">Espuma:</strong> Sella Sangrado auto.</li></ul>', color: "text-green-200", uses: 3, type: "kit" },
            { name: "Medkit Imperialis", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-gray-300">Básico:</strong> Evita penalizador -20.</li></ul>', color: "text-gray-400", type: "kit" },
            { name: "Kit Dientes-Flojos", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-yellow-600">Apaño:</strong> Repetir 1 tirada de Tecnología.</li></ul>', color: "text-yellow-600", type: "kit" },
            { name: "Vendas Estériles", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-white">Auxilio:</strong> +20 Primeros Auxilios. +1d5 Heridas extra.</li></ul>', color: "text-white", type: "item" },
            { name: "Lata Aceite Industrial", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-yellow-500">Mantenimiento:</strong> Arma se vuelve "Fiable".</li></ul>', color: "text-yellow-500", type: "item" },
            { name: "Mod: El Kallador", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-red-400">Ruidoso:</strong> +Intimidar, -Sigilo.</li></ul>', color: "text-red-400", type: "mod" },
            { name: "Pelusa Orko", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-green-600">Inútil:</strong> -5 Empatía si se come.</li></ul>', color: "text-green-600", type: "trash" },
            { name: "Bocadillo Moho", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-yellow-700">Rancio:</strong> +1 Herida, +2 Hambre.</li></ul>', color: "text-yellow-700", type: "trash" },
            { name: "Rata Muerta", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-gray-300">Riesgo:</strong> Test R: Nutrición o Náuseas.</li></ul>', color: "text-gray-500", type: "trash" },
            { name: "Licor Hongo", effect: '<ul class="list-disc pl-4 lore-list"><li><strong class="text-red-500">Molotov:</strong> 1d10 Fuego (Lanzar).</li><li><strong class="text-green-500">Beber:</strong> Vigor, Ceguera o Daño.</li></ul>', color: "text-green-500", type: "trash" }
        ];

        // --- BUFFS DATA ---
        let buffsDB = [
            { 
                title: "Regeneración Biológica", 
                desc: "<p class='mb-2'>Durante el próximo combate, Angryhands recuperará <strong>1 Herida por asalto</strong> automáticamente debido a la vitalidad extrema que fluye por su sangre.</p>", 
                type: "temp", 
                color: "buff-green", 
                icon: "fa-heart-pulse", 
                text: "text-green-400" 
            },
            { 
                title: "Presencia Dominante", 
                desc: "<p class='mb-2'>Tus cuerdas vocales mutan para emitir el rugido subsónico de la Madre.</p><ul class='list-disc pl-4 lore-list'><li>Ganas la habilidad <strong>Intimidar</strong> como entrenada.</li><li>Si ya la tenías, recibes un bonificador de <strong>+10 permanente</strong>.</li></ul><p class='mt-2'><strong class='text-white'>Grito Ululante:</strong> Una vez/fase, emite un alarido. Enemigos Test Miedo (-10).</p>", 
                type: "perm", 
                color: "buff-purple", 
                icon: "fa-bullhorn", 
                text: "text-purple-400" 
            },
            { 
                title: "Mejora: +5 Agilidad Base", 
                desc: "Mejora genética permanente. Tus reflejos y velocidad de movimiento base han aumentado.", 
                type: "perm", 
                color: "buff-purple", 
                icon: "fa-angles-up", 
                text: "text-purple-400" 
            },
            { 
                title: "Movimiento Ágil (Habilidad)", 
                desc: "<ul class='list-disc pl-4 lore-list'><li><strong class='text-white'>Velocidad:</strong> Ignora reducción movimiento terreno difícil.</li><li><strong class='text-white'>Carga:</strong> No necesitas tirar Agilidad para no tropezar.</li><li><strong class='text-white'>Sigilo:</strong> Te mueves sin hacer ruidos accidentales.</li></ul>", 
                type: "perm", 
                color: "buff-red", 
                icon: "fa-person-running", 
                text: "text-red-400" 
            },
            { 
                title: "Resistencia Toxinas (+10)", 
                desc: "Tu metabolismo procesa venenos con mayor eficacia. +10 a todas las pruebas de Resistencia contra toxinas.", 
                type: "perm", 
                color: "buff-purple", 
                icon: "fa-skull-crossbones", 
                text: "text-purple-400" 
            },
            { 
                title: "Olfato Desarrollado (+10 PER)", 
                desc: "Adaptación de rata. +10 a Percepción en tiradas de olfato (rastreo, emboscadas).", 
                type: "perm", 
                color: "buff-purple", 
                icon: "fa-dog", 
                text: "text-purple-400" 
            }
        ];

        let equipped = {
            main: null, off: null,
            head: null, body: null, wrists: null,
            hands: null, legs: null, feet: null,
            trinket1: null, trinket2: null
        };

        // --- RENDERIZADO ---
        function initInventory() {
            renderWeapons();
            renderArmor();
            renderSnacks();
            renderConsumables();
            renderBuffs();
            // Equip Defaults (Only first time)
            if(!equipped.body) equipArmor('a_chaleco');
            if(!equipped.feet) equipArmor('a_botas');
        }

        // --- UPDATE ACTIVE GEAR INFO ---
        function updateActiveGearInfo() {
            const container = document.getElementById('active-gear-info');
            if(!container) return;
            
            container.innerHTML = '';
            
            const slots = [
                { key: 'main', label: 'M. Principal' },
                { key: 'off', label: 'Secundaria' },
                { key: 'head', label: 'Cabeza' },
                { key: 'body', label: 'Torso' },
                { key: 'hands', label: 'Guantes' },
                { key: 'wrists', label: 'Muñecas' },
                { key: 'legs', label: 'Piernas' },
                { key: 'feet', label: 'Pies' },
                { key: 'trinket1', label: 'Abalorio 1' },
                { key: 'trinket2', label: 'Abalorio 2' }
            ];

            let hasItems = false;

            slots.forEach(slot => {
                const item = equipped[slot.key];
                if (item) {
                    hasItems = true;
                    const el = document.createElement('details');
                    // Colors based on item rarity/type if possible, or default blue/green
                    let borderColor = 'buff-blue';
                    let titleColor = 'text-blue-400';
                    
                    if (item.rarity === 'rare') { borderColor = 'buff-purple'; titleColor = 'text-purple-400'; }
                    if (item.rarity === 'epic') { borderColor = 'buff-red'; titleColor = 'text-red-400'; }
                    if (item.rarity === 'uncommon') { borderColor = 'buff-green'; titleColor = 'text-green-400'; }

                    el.className = `buff-card ${borderColor} group`;
                    el.innerHTML = `
                        <summary class="p-2 flex justify-between items-center cursor-pointer select-none hover:bg-white/5 transition">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fas ${item.icon} ${titleColor} w-4 text-center shrink-0"></i>
                                <span class="font-bold text-[10px] ${titleColor} uppercase truncate">${slot.label}: ${item.name}</span>
                            </div>
                            <i class="fas fa-chevron-down text-[9px] text-gray-500 group-open:rotate-180 transition"></i>
                        </summary>
                        <div class="px-2 pb-2 text-[10px] text-gray-400 border-t border-[#333] pt-2 rich-text bg-black/20">
                            <div class="mb-1 text-white font-mono text-[9px]">${item.stats}</div>
                            ${item.desc}
                        </div>
                    `;
                    container.appendChild(el);
                }
            });

                    if (!hasItems) {
                container.innerHTML = '<div class="text-center text-gray-400 text-[10px] italic p-2 border border-dashed border-gray-700 rounded">Sin equipo activo</div>';
            }
        }

        // ... (Rest of functions remain similar, ensuring innerHTML is used)
        function renderWeapons() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            weaponsDB.forEach((item, index) => {
                const isEquipped = (equipped.main && equipped.main.id === item.id) || (equipped.off && equipped.off.id === item.id);
                const el = document.createElement('details');
                el.className = 'group border-b border-[#222] last:border-0 buff-card border-l-0 mb-0'; // Reusing buff-card style for bg
                const btnText = isEquipped ? "QUITAR" : "EQUIPAR";
                const btnClass = isEquipped ? "border-red-900 text-red-500 hover:bg-red-900/50" : "border-gray-700 text-gray-300 hover:bg-white hover:text-black";
                const actionFn = isEquipped ? `unequipWeaponById('${item.id}')` : `equipWeapon('${item.id}')`;
                el.innerHTML = `
                    <summary class="p-2 hover:bg-[#1a1a1a] flex justify-between items-center cursor-pointer select-none">
                        <div class="flex items-center gap-2 overflow-hidden w-full">
                            <i class="fas ${item.icon} ${item.color} w-5 text-center shrink-0"></i>
                            <div class="min-w-0 flex-grow">
                                <div class="font-bold ${item.color} truncate text-xs">${item.name}</div>
                                <div class="text-[9px] text-gray-300 truncate">${item.type.toUpperCase()} <span class="text-gray-400">|</span> ${item.stats}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0 ml-2">
                            <button onclick="${actionFn}; event.preventDefault();" class="text-[9px] border px-2 py-1 rounded transition ${btnClass}">${btnText}</button>
                            <button onclick="deleteWeapon(${index}); event.preventDefault();" class="text-[#444] hover:text-red-500 text-[10px] p-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </summary>
                    <div class="px-2 pb-2 text-[10px] text-gray-200 bg-[#111] leading-tight border-t border-[#222] pt-2 rich-text">
                        ${item.desc}
                    </div>
                `;
                list.appendChild(el);
            });
            document.getElementById('w-count').innerText = `${weaponsDB.length} items`;
        }

        function renderArmor() {
            const list = document.getElementById('armor-list');
            list.innerHTML = '';
            armorDB.forEach((item, index) => {
                let isEquipped = false;
                if(item.slot === 'trinket') {
                    isEquipped = (equipped.trinket1 && equipped.trinket1.id === item.id) || (equipped.trinket2 && equipped.trinket2.id === item.id);
                } else {
                    isEquipped = equipped[item.slot] && equipped[item.slot].id === item.id;
                }
                const el = document.createElement('details');
                el.className = 'group border-b border-[#222] last:border-0 buff-card border-l-0 mb-0';
                const btnText = isEquipped ? "QUITAR" : "EQUIPAR";
                const btnClass = isEquipped ? "border-red-900 text-red-500 hover:bg-red-900/50" : "border-gray-700 text-gray-300 hover:bg-white hover:text-black";
                const actionFn = isEquipped ? `unequipArmorById('${item.id}')` : `equipArmor('${item.id}')`;
                el.innerHTML = `
                    <summary class="p-2 hover:bg-[#1a1a1a] flex justify-between items-center cursor-pointer select-none">
                        <div class="flex items-center gap-2 overflow-hidden w-full">
                            <i class="fas ${item.icon} ${item.color} w-5 text-center shrink-0"></i>
                            <div class="min-w-0 flex-grow">
                                <div class="font-bold ${item.color} truncate text-xs">${item.name}</div>
                                <div class="text-[9px] text-gray-300 truncate">${item.slot.toUpperCase()} <span class="text-gray-400">|</span> ${item.stats}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0 ml-2">
                            <button onclick="${actionFn}; event.preventDefault();" class="text-[9px] border px-2 py-1 rounded transition ${btnClass}">${btnText}</button>
                            <button onclick="deleteArmor(${index}); event.preventDefault();" class="text-[#444] hover:text-red-500 text-[10px] p-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </summary>
                    <div class="px-2 pb-2 text-[10px] text-gray-200 bg-[#111] leading-tight border-t border-[#222] pt-2 rich-text">
                        ${item.desc}
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function renderSnacks() {
            const list = document.getElementById('snacks-list');
            list.innerHTML = '';
            snacksDB.forEach((item) => {
                const el = document.createElement('div');
                el.className = 'p-2 hover:bg-[#1a1a1a] border-b border-[#222] last:border-0 flex justify-between items-start gap-2';
                const onClick = item.hungerRestore ? `onclick="if(this.checked){updateHunger(${item.hungerRestore}); showToast('+3 Hambre');}"` : '';
                let checksHtml = '';
                const count = item.uses || 1;
                for(let i=0; i<count; i++) {
                    checksHtml += `<input type="checkbox" class="kroot-check" ${onClick}>`;
                }
                el.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="text-xs font-bold ${item.color} truncate pr-2">${item.name}</span>
                        </div>
                        <div class="text-[10px] text-gray-200 leading-tight break-words rich-text">${item.effect}</div>
                    </div>
                    <div class="shrink-0 pt-1 flex gap-1">${checksHtml}</div>
                `;
                list.appendChild(el);
            });
        }

        function renderConsumables() {
            const list = document.getElementById('consumables-list');
            list.innerHTML = '';
            lootDB.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'p-2 hover:bg-[#1a1a1a] group flex justify-between items-start gap-2 border-b border-[#222] last:border-0';
                let checksHtml = '';
                const count = item.uses || 1;
                for(let i=0; i<count; i++) {
                    checksHtml += `<input type="checkbox" class="kroot-check">`;
                }
                el.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="text-xs font-bold ${item.color} truncate pr-2">${item.name}</span>
                        </div>
                        <div class="text-[10px] text-gray-200 leading-tight break-words rich-text">${item.effect}</div>
                    </div>
                    <div class="flex flex-col items-end gap-1 shrink-0">
                        <div class="flex gap-1">${checksHtml}</div>
                        <button onclick="deleteConsumable(${index}); event.stopPropagation();" title="Eliminar Objeto" class="text-[#444] hover:text-red-500 text-[10px] p-1 opacity-0 group-hover:opacity-100 transition focus:outline-none"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function renderBuffs() {
            const tempList = document.getElementById('temp-buffs-list');
            const permList = document.getElementById('perm-buffs-list');
            tempList.innerHTML = '';
            permList.innerHTML = '';

            buffsDB.forEach((buff, index) => {
                const el = document.createElement('details');
                el.className = `buff-card ${buff.color} group`;
                
                el.innerHTML = `
                    <summary class="p-2 flex justify-between items-center cursor-pointer select-none">
                        <div class="flex items-center gap-2">
                            <i class="fas ${buff.icon} ${buff.text} w-4 text-center"></i>
                            <span class="font-bold text-xs ${buff.text}">${buff.title}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-chevron-down text-[10px] text-gray-200 group-open:rotate-180 transition"></i>
                            <button onclick="deleteBuff(${index}); event.preventDefault();" class="text-gray-300 hover:text-red-500 px-1"><i class="fas fa-times"></i></button>
                        </div>
                    </summary>
                    <div class="px-2 pb-2 text-[10px] text-gray-200 whitespace-pre-wrap leading-tight border-t border-[#333] pt-2 rich-text">
                        ${buff.desc}
                    </div>
                `;

                if (buff.type === 'temp') tempList.appendChild(el);
                else permList.appendChild(el);
            });
        }

        // --- ADD/DELETE BUFFS ---
        function addNewBuff() {
            const nameInput = document.getElementById('newBuffName');
            const typeInput = document.getElementById('newBuffType');
            const descInput = document.getElementById('newBuffDesc');
            const colorInput = document.getElementById('newBuffColor');
            const iconInput = document.getElementById('newBuffIcon');

            const title = nameInput.value.trim();
            const desc = descInput.innerHTML;
            const type = typeInput.value;
            const colorClass = colorInput.value; // e.g., 'buff-green'
            const iconClass = iconInput.value;

            if (!title) {
                showToast("Falta nombre");
                return;
            }

            // Map color class to text color class
            let textClass = 'text-gray-200';
            if (colorClass === 'buff-green') textClass = 'text-green-400';
            else if (colorClass === 'buff-purple') textClass = 'text-purple-400';
            else if (colorClass === 'buff-red') textClass = 'text-red-400';
            else if (colorClass === 'buff-blue') textClass = 'text-blue-400';

            const newBuff = {
                title: title,
                desc: desc,
                type: type,
                color: colorClass,
                icon: iconClass,
                text: textClass
            };
            
            buffsDB.push(newBuff);
            renderBuffs();
            
            // Clear inputs
            nameInput.value = '';
            descInput.innerHTML = '';
            showToast("Buff añadido");
        }

        function deleteBuff(index) {
            // Direct delete with toast feedback, no confirm() blocking
            const item = buffsDB[index];
            buffsDB.splice(index, 1);
            renderBuffs();
            showToast(`Buff eliminado: ${item.title}`);
        }

        // --- GESTIÓN DE ITEMS ---
        function addWeapon() {
            const name = document.getElementById('newWeaponName').value;
            const stats = document.getElementById('newWeaponStats').value;
            const desc = document.getElementById('newWeaponDesc').innerHTML;
            const type = document.getElementById('newWeaponType').value;
            const color = document.getElementById('newWeaponColor').value;
            if(name && stats) {
                weaponsDB.push({id: 'w_' + Date.now(), name: name, stats: stats, type: type, color: color, icon: type === 'shield' ? 'fa-shield-alt' : 'fa-khanda', rarity: 'common', desc: desc || '<p>Arma personalizada.</p>'});
                renderWeapons();
                document.getElementById('newWeaponName').value = '';
                document.getElementById('newWeaponStats').value = '';
                document.getElementById('newWeaponDesc').innerHTML = '';
            } else { showToast("Faltan datos"); }
        }
        function deleteWeapon(index) {
            const item = weaponsDB[index];
            if(equipped.main && equipped.main.id === item.id) unequip('main');
            if(equipped.off && equipped.off.id === item.id) unequip('off');
            weaponsDB.splice(index, 1);
            renderWeapons();
            showToast(`Arma eliminada: ${item.name}`);
        }
        function addArmor() {
            const name = document.getElementById('newArmorName').value;
            const stats = document.getElementById('newArmorStats').value;
            const desc = document.getElementById('newArmorDesc').innerHTML;
            const slot = document.getElementById('newArmorSlot').value;
            const color = document.getElementById('newArmorColor').value;
            if(name && stats) {
                let icon = 'fa-shield-halved';
                if(slot === 'head') icon = 'fa-helmet-safety'; if(slot === 'body') icon = 'fa-vest'; if(slot === 'hands') icon = 'fa-mitten';
                if(slot === 'wrists') icon = 'fa-ring'; if(slot === 'legs') icon = 'fa-socks'; if(slot === 'feet') icon = 'fa-boot'; if(slot === 'trinket') icon = 'fa-gem';
                armorDB.push({id: 'a_' + Date.now(), name: name, stats: stats, slot: slot, color: color, icon: icon, rarity: 'common', desc: desc || '<p>Protección personalizada.</p>'});
                renderArmor();
                document.getElementById('newArmorName').value = '';
                document.getElementById('newArmorStats').value = '';
                document.getElementById('newArmorDesc').innerHTML = '';
            } else { showToast("Faltan datos"); }
        }
        function deleteArmor(index) {
            const item = armorDB[index];
            if (item.slot === 'trinket') { if (equipped.trinket1 && equipped.trinket1.id === item.id) unequip('trinket1'); if (equipped.trinket2 && equipped.trinket2.id === item.id) unequip('trinket2'); } 
            else { if(equipped[item.slot] && equipped[item.slot].id === item.id) unequip(item.slot); }
            armorDB.splice(index, 1);
            renderArmor();
            showToast(`Armadura eliminada: ${item.name}`);
        }
        function addConsumable() {
            const name = document.getElementById('newItemName').value;
            const desc = document.getElementById('newItemDesc').innerHTML;
            const color = document.getElementById('newItemColor').value;
            if (name && desc) {
                lootDB.push({ name: name, effect: desc, color: color });
                renderConsumables();
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemDesc').innerHTML = '';
            } else { showToast("Falta nombre o descripción"); }
        }
        function deleteConsumable(index) {
            const item = lootDB[index];
            lootDB.splice(index, 1);
            renderConsumables();
            showToast(`Eliminado: ${item.name}`);
        }

        // --- EQUIPAMIENTO ---
        function equipWeapon(id) {
            const item = weaponsDB.find(w => w.id === id);
            if (!item) return;

            if (item.type === '2h') {
                equipped.main = item;
                equipped.off = null;
                updateSlot('main', item);
                updateSlot('off', null, true);
                document.getElementById('2h-warning').classList.remove('hidden');
            } else {
                document.getElementById('2h-warning').classList.add('hidden');
                if (equipped.main && equipped.main.type === '2h') { equipped.main = null; updateSlot('main', null); }
                
                if (!equipped.main) { equipped.main = item; updateSlot('main', item); }
                else if (!equipped.off) { equipped.off = item; updateSlot('off', item); }
                else { equipped.main = item; updateSlot('main', item); }
            }
            checkProtocols();
            renderWeapons(); // Update buttons
            updateActiveGearInfo();
        }

        function unequipWeaponById(id) {
            if (equipped.main && equipped.main.id === id) unequip('main');
            else if (equipped.off && equipped.off.id === id) unequip('off');
        }

        function equipArmor(id) {
            const item = armorDB.find(a => a.id === id);
            if(!item) return;

            if (item.slot === 'trinket') {
                // Trinket logic: fill 1, then 2, then swap 1
                if (!equipped.trinket1) {
                    equipped.trinket1 = item;
                    updateSlot('trinket1', item);
                } else if (!equipped.trinket2) {
                    equipped.trinket2 = item;
                    updateSlot('trinket2', item);
                } else {
                    equipped.trinket1 = item; // Swap 1
                    updateSlot('trinket1', item);
                }
            } else {
                // Standard slot
                equipped[item.slot] = item;
                updateSlot(item.slot, item);
            }
            renderArmor();
            updateActiveGearInfo();
        }

        function unequipArmorById(id) {
            // Find where it is equipped
            const item = armorDB.find(a => a.id === id);
            if (!item) return;

            if (item.slot === 'trinket') {
                if (equipped.trinket1 && equipped.trinket1.id === id) unequip('trinket1');
                else if (equipped.trinket2 && equipped.trinket2.id === id) unequip('trinket2');
            } else {
                if (equipped[item.slot] && equipped[item.slot].id === id) unequip(item.slot);
            }
        }

        function unequip(slot) {
            equipped[slot] = null;
            updateSlot(slot, null);
            if(slot === 'main' || slot === 'off') {
                document.getElementById('2h-warning').classList.add('hidden');
                if (slot === 'main') updateSlot('off', equipped.off);
                checkProtocols();
                renderWeapons();
            } else {
                renderArmor();
            }
            updateActiveGearInfo();
        }

        // --- UI CORE ---
        function updateSlot(slotId, item, blocked = false) {
            const el = document.getElementById(`slot-${slotId}`);
            if(!el) return;
            el.className = 'gear-slot';
            el.innerHTML = '';
            
            let defaultIcon = '';
            if(slotId === 'main') defaultIcon = 'fa-fist-raised';
            if(slotId === 'off') defaultIcon = 'fa-hand-paper';
            if(slotId === 'head') defaultIcon = 'fa-helmet-safety';
            if(slotId === 'body') defaultIcon = 'fa-vest';
            if(slotId === 'hands') defaultIcon = 'fa-mitten';
            if(slotId === 'wrists') defaultIcon = 'fa-ring';
            if(slotId === 'legs') defaultIcon = 'fa-socks';
            if(slotId === 'feet') defaultIcon = 'fa-boot';
            if(slotId === 'trinket1' || slotId === 'trinket2') defaultIcon = 'fa-gem';

            if (!item) {
                el.classList.add('border-dashed', 'border-gray-600');
                if(blocked) {
                    el.classList.add('opacity-25', 'cursor-not-allowed');
                    el.innerHTML = `<i class="fas fa-ban text-red-900"></i>`; 
                } else {
                    el.innerHTML = `<i class="fas ${defaultIcon} text-gray-300"></i>`;
                }
                return;
            }

            el.classList.add('filled', item.rarity);
            el.innerHTML = `
                <i class="fas ${item.icon} text-white"></i>
                <div class="item-tooltip">
                    <div class="font-bold ${item.color} mb-1 border-b border-gray-600 pb-1">${item.name}</div>
                    <div class="text-[10px] text-white font-mono mb-1 bg-black/50 p-1 rounded">${item.stats}</div>
                    <div class="text-[9px] text-gray-200 italic leading-tight">${item.desc}</div>
                </div>
            `;
        }

        function checkProtocols() {
            const proto = document.getElementById('protocol-display');
            if (equipped.main && equipped.off && 
               ((equipped.main.id === 'w_sierra' && equipped.off.id === 'w_tenedor') || 
                (equipped.main.id === 'w_tenedor' && equipped.off.id === 'w_sierra'))) {
                proto.classList.remove('hidden');
            } else {
                proto.classList.add('hidden');
            }
        }

        function showToast(msg) {
            let toast = document.getElementById('toast-msg');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-msg';
                toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-900 border border-red-500 text-white px-4 py-2 rounded shadow-[0_0_15px_rgba(239,68,68,0.5)] text-xs font-bold z-50 transition-opacity duration-300 pointer-events-none opacity-0';
                document.body.appendChild(toast);
            }
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            if(window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { toast.classList.add('opacity-0'); }, 2000);
        }

        // --- STATS ---
        function modVal(id, change) {
            const input = document.getElementById(id);
            if(input) {
                let current = parseInt(input.value) || 0;
                input.value = current + change;
                input.style.color = change > 0 ? '#4ade80' : '#f87171';
                setTimeout(() => input.style.color = '', 300);
            }
        }

        function roll(sides) {
            const display = document.getElementById('rollResult');
            let count = 0;
            const max = 10;
            const interval = setInterval(() => {
                display.innerText = Math.floor(Math.random() * sides) + 1;
                count++;
                if(count >= max) {
                    clearInterval(interval);
                    const final = Math.floor(Math.random() * sides) + 1;
                    display.innerText = final;
                    display.className = 'text-2xl font-mono font-bold ' + (final === sides || (sides===100 && final <=10) ? 'text-green-500' : (final===1 || (sides===100 && final >=90) ? 'text-red-500' : 'text-white'));
                }
            }, 50);
        }

        let hunger = 10;
        function updateHunger(amount) {
            hunger = Math.min(10, Math.max(0, hunger + amount));
            document.getElementById('hungerValue').innerText = hunger;
            const die = document.querySelector('.hunger-die');
            
            // Visual Update
            document.getElementById('status-10').style.opacity = '0.3';
            document.getElementById('status-6').style.opacity = '0.3';
            document.getElementById('status-3').style.opacity = '0.3';
            document.getElementById('status-0').style.opacity = '0.3';
            die.className = "hunger-die shadow-none transition-all duration-300 border-gray-700 text-gray-500"; // Reset

            if (hunger >= 7) {
                die.classList.add('text-green-400', 'border-green-500');
                die.style.boxShadow = '0 0 15px rgba(74, 222, 128, 0.3)';
                document.getElementById('status-10').style.opacity = '1';
            } else if (hunger >= 4) {
                die.classList.add('text-yellow-400', 'border-yellow-500');
                die.style.boxShadow = '0 0 15px rgba(250, 204, 21, 0.3)';
                document.getElementById('status-6').style.opacity = '1';
            } else if (hunger >= 1) {
                die.classList.add('text-red-400', 'border-red-500');
                die.style.boxShadow = '0 0 15px rgba(248, 113, 113, 0.4)';
                document.getElementById('status-3').style.opacity = '1';
            } else {
                die.classList.add('text-red-600', 'border-red-700', 'animate-pulse');
                document.getElementById('status-0').style.opacity = '1';
            }
        }

        function addBuff() {
            const name = prompt("Nombre del Buff/Mutación:");
            if(name) {
                const desc = prompt("Efecto (ej: +10 Fuerza):");
                const list = document.getElementById('buff-list');
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-[#1a1a1a] p-2 rounded border-l-2 border-gray-500 animate-[slideDown_0.2s_ease-out]";
                li.innerHTML = `
                    <div>
                        <span class="block font-bold text-gray-200">${name}</span>
                        <span class="text-[10px] text-gray-500">${desc}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-gray-600 hover:text-red-500"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(li);
            }
        }

        initInventory();
        updateHunger(0); // Init visuals
    </script>
</body>
</html>
